```{r load-packages, message = FALSE}
library(tidyverse)
library(broom)
library(readr)
library(ggridges)
library(ggplot2)
library(usmap)
library(dplyr)
library(tigris)
library(stringr)
# install.packages("leaflet")
library(leaflet)
library(sf)
library("visdat")
library(naniar)
library(UpSetR)
# install.packages("devtools")
library(devtools)
devtools::install_github("hrbrmstr/streamgraph")
```

```{r analysis}
victims_incidents <- read_csv("../data/victims_incidents.csv")
glimpse(victims_incidents)
```
```{r}
summary(victims_incidents)
```

```{r incidents_count_by_state}
victims_incidents %>%
  group_by(state) %>%
  summarise(total_incidents = n()) %>%
  arrange(desc(total_incidents)) %>% 
  print()
```

``` {r incidents_alabama_counties}
fips_data <- tigris::counties(state = "Alabama", class = "sf") %>%
  select(fips = GEOID, county = NAME)

alabama_incidents_fix <- victims_incidents %>%
  filter(state == "Alabama") %>%
  mutate(county = str_replace(county, " County", "")) %>%  # because county names don't match fips data
  group_by(county) %>%
  summarise(incident_count = n(), .groups = 'drop')

alabama_incidents <- alabama_incidents_fix %>%
  left_join(fips_data, by = "county")

 sorted_alabama <- alabama_incidents %>% 
  arrange(desc(incident_count)) %>% 
 print(sorted_alabama)
 
plot_usmap(regions = "counties", data = alabama_incidents, values = "incident_count", include = "AL", color = "black") +
 scale_fill_continuous(low = "white", high = "red", name = "Incidents Count", na.value = "white") +
  labs(title = "Number of Incidents by County in Alabama",
       subtitle = "Of 203 total incidents in the state") +
  theme(legend.position = "right")
```

``` {r leaflet-trial}
county_shapes <- counties(state= c("AL", "AR", "FL", "GA", "LA", "MS", "NC", "TN", "TX", "VA"), cb=FALSE, resolution="500k")

#leaflet(victims_incidents)

all_counties_map <- victims_incidents %>% 
  mutate(county = str_replace(county, " County", "")) %>%  # because county names don't match fips data
  group_by(state, county) %>%
  summarise(incident_count = n(), .groups = 'drop') %>% 
  arrange(state, desc(incident_count))
  
  county_shapes <- county_shapes
 # mutate(county = str_replace(county, " County", "")) # to match

all_counties_map_with_shapes <- all_counties_map %>%
  left_join(county_shapes, by = c("geometry"))

leaflet(data = all_counties_map_with_shapes) %>% 
  addTiles() %>% 
  addPolygons(fillColor = ~pal(incident_count)
```

```{r spaghetti plot}
# Load dataset from github

data <- victims_incidents %>%
  filter(state %in% c("Alabama", "Arkansas", "Louisiana", "Mississippi", "North Carolina", "South Carolina", "Tennessee", "Texas", "Virginia")) |>
  mutate(year = incident_year_range_beg) |>
  group_by(year, state, sex) |>
  summarize(n = n())

# Plot
data %>%
  drop_na(sex) |>
  ggplot( aes(x=year, y=n, group=state, color=state)) +
    geom_line() +
    scale_color_viridis(discrete = TRUE) +
    theme(
      legend.position="none",
      plot.title = element_text(size=15)) +
    ggtitle("Incident Count by State")
    theme_ipsum()
```

